# Kubernetes_RFD

```
Multiple Kubernetes projects for all kinds of problems.
```



## Prerequisites

You need to have a Kubernetes cluster available.

If you do not have one, you can virtualize with tools such as minikube in version v1.16.0 or higher. https://github.com/kubernetes/minikube

All the custom images that will be used in this repository have been generated by dockerfile or similar files from the following repository: https://github.com/JoseManuelPS/Docker_RFD

It is recommended to have a proprietary image repository such as Docker Registry or Nexus to facilitate the image management task.



## nexus_repository 

This short tutorial explains in a simple way how to deploy the Nexus Repository OSS image repository (https://www.sonatype.com/nexus/repository-oss).

**Important: A deployment is going to be carried out without certificates, if you want to carry out a deployment with certificates you can find more information at: https://help.sonatype.com/repomanager3**


### Recommended deploy instrucctions:
```
kubectl create --save-config -f <(path_to_nexus_namespaces)>
kubectl create --save-config -f <(path_to_nexus_deployment)> -f <(path_to_nexus_service)> -f <(path_to_nexus_ingress)>
```


### Example deploy instrucction:
```
kubectl create --save-config -f ~/projects/kubernetes_rfd/nexus_repository/ns.nexus_repository.yaml
kubectl create --save-config -f ~/projects/kubernetes_rfd/nexus_repository/deploy.nexus_repository.yaml -f ~/projects/kubernetes_rfd/nexus_repository/ingress.nexus_repository.yaml -f ~/projects/kubernetes_rfd/nexus_repository/svc.nexus_repository.yaml
```


### Configure and access to your own Nexus Repository OSS.

Now your Nexus Repository OSS it's ready. To use it, you must access to http://nexus.local (Remember modify your /etc/hosts), log in as `admin`, and complete the initial setup. After the configuration is complete, you must create a new Docker repository as type `hosted` with the port `5000`.

Once the deployment has been done, and the new Docker repository created you can connect to it following this steps:

- Create or modify the file /etc/docker/daemon.json to include the following content:
```
{
    "insecure-registries" : [ "docker.local:<(5000_port_mapped_as_nodeport)>" ]
}
```

- Reset Docker daemon. 

- Connect to repository:
```
docker login docker.local:<(5000_port_mapped_as_nodeport)>
```


### Recommended push instrucctions:
```
docker tag <(image_name:version)> docker.local:<(5000_port_mapped_as_nodeport)>/<(repository_name)>/<(image_name:version)>
docker push docker.local:<(5000_port_mapped_as_nodeport)>/<(repository_name)>/<(image_name:version)>
```


### Example push instrucction:
```
docker tag hello_world:v1.0 docker.local:32343/docker_repo/hello_world:v1.0
docker push docker.local:32343/docker_repo/hello_world:v1.0
```


### Recommended pull instrucctions:
```
docker pull docker.local:<(5000_port_mapped_as_nodeport)>/<(repository_name)>/<(image_name:version)>
```


### Example pull instrucction:
```
docker pull docker.local:32343/docker_repo/hello_world:v1.0
```



## nexus_repository (minikube version)

This short tutorial explains in a simple way how to deploy the Nexus Repository OSS image repository (https://www.sonatype.com/nexus/repository-oss) inside of minikube.

Start minikube with the parameter --insecure-registry, like this:
```
minikube start --insecure-registry "10.0.0.0/24"
```

Add minikube ip to the /etc/hosts file with the following names:
- nexus.local (It will be used to access the nexus service)
- docker.local (It will be used to access the docker repository)

Use the following command to check it:
```
minikube ip
```

You must also enable the ingress addon. Use the following command to add it.
```
minikube addons enable ingress
```

**Important: A deployment is going to be carried out without certificates, if you want to carry out a deployment with certificates you can find more information at: https://help.sonatype.com/repomanager3**


### Recommended deploy instrucctions:
```
kubectl create --save-config -f <(path_to_nexus_namespaces)>
kubectl create --save-config -f <(path_to_nexus_deployment)> -f <(path_to_nexus_service)> -f <(path_to_nexus_ingress)>
```


### Example deploy instrucction:
```
kubectl create --save-config -f ~/projects/kubernetes_rfd/nexus_repository/ns.nexus_repository.yaml
kubectl create --save-config -f ~/projects/kubernetes_rfd/nexus_repository/deploy.nexus_repository.yaml -f ~/projects/kubernetes_rfd/nexus_repository/ingress.nexus_repository.yaml -f ~/projects/kubernetes_rfd/nexus_repository/svc.nexus_repository.yaml
```


### Configure and access to your own Nexus Repository OSS.

Now your Nexus Repository OSS it's ready. To use it, you must access to http://nexus.local address, log in as `admin`, and complete the initial setup. 

Once you have successfully logged in, go to Settings>Security>Realms and enable `Docker Bearer Token Realm`.

After the configuration is complete, you must create a new Docker repository as type `hosted` with the port `5000`.

Once the deployment has been done, and the new Docker repository created you can connect to it following this steps:

- If you want to connect from outside of minikube create or modify the file /etc/docker/daemon.json to include the following content:

```
{
    "insecure-registries" : [ "docker.local:<(5000_port_mapped_as_nodeport)>" ]
}
```

- Reset Docker daemon and start again minikube. 
```
systemctl stop docker.service docker.socket
systemctl start docker.service
minikube start --insecure-registry "10.0.0.0/24"
```

- Connect from outside of minikube:
```
docker login docker.local:<(5000_port_mapped_as_nodeport))>
```

- Connect from inside of minikube:
```
eval $(minikube docker-env)
docker login svc-nexus:5000 
```


### Recommended push instrucctions:
```
docker tag <(image_name:version)> svc-nexus:5000/<(repository_name)>/<(image_name:version)>
docker push svc-nexus:5000/<(repository_name)>/<(image_name:version)>
```

_If you want to push from outside of minikube replace svc-nexus:5000 for docker.local:<(5000_port_mapped_as_nodeport)>_


### Example push instrucction:
```
docker tag hello_world:v1.0 svc-nexus:5000/docker_repo/hello_world:v1.0
docker push svc-nexus:5000/docker_repo/hello_world:v1.0
```


### Recommended pull instrucctions:
```
docker pull svc-nexus:5000/<(repository_name)>/<(image_name:version)>
```

_If you want to pull from outside of minikube replace svc-nexus:5000 for docker.local:<(5000_port_mapped_as_nodeport)>_


### Example pull instrucction:
```
docker pull svc-nexus:5000/docker_repo/hello_world:v1.0
```


